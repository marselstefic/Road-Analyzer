<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        #map {
            height: 400px;
        }
    </style>
<script>
    $(document).ready(function() {
      var map = L.map('map').setView([46.1512, 14.9955], 7);
  
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 18,
      }).addTo(map);
  
      // Get the username from the session
      var username = "{{ session['username'] }}";
  
      function displayMarkers(data) {
  // Filter the data based on the logged-in user
  var filteredData = data.filter(function(item) {
    return item.postedBy === username;
  });

  console.log("Filtered Data:", filteredData);

  // Display the waypoints for the filtered data
  filteredData.forEach(function(item) {
    var value = item.value;
    var color = getColor(value);
    console.log("Latitude:", item.latitude);
    console.log("Longitude:", item.longitude);

    var marker = L.circleMarker([item.latitude, item.longitude], {
      radius: 5,
      fillColor: color,
      color: '#000',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(map);
    marker.bindPopup(
      "Value: " + value + "<br>" +
      "Longitude: " + item.longitude + "<br>" +
      "Latitude: " + item.latitude
    );
  });
}
  
      // Send an AJAX request to fetch the data for the logged-in user
      $.ajax({
        url: '/mydata',
        type: 'GET',
        success: function(response) {
          if (response.hasOwnProperty('error')) {
            console.log("Error:", response.error);
          } else {
            console.log("Response:", response);
            displayMarkers(response);
          }
        },
        error: function(error) {
          console.log(error);
        }
      });
    });
  
    function getColor(value) {
      if (value >= 0 && value < 3) {
        return 'green';
      } else if (value >= 3 && value < 7) {
        return 'yellow';
      } else if (value >= 7 && value <= 10) {
        return 'red';
      } else {
        return 'blue'; // Default color if value is outside the specified range
      }
    }
  
    function confirmLogout() {
      var logout = confirm("Do you want to logout?");
      if (logout) {
        $.ajax({
          url: '/logout',
          type: 'POST',
          success: function() {
            window.location.href = "/";
          },
          error: function(error) {
            console.log(error);
          }
        });
      }
    }
  </script>

    
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top" style="background-color: rgba(255, 255, 255, 0.8);">
        <a class="navbar-brand" href="/"><i class="fas fa-wave-square"></i><b>Road-Analyzer</b></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse  justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Homepage</a>
                </li>
                {% if 'username' not in session %}
                <li class="nav-item">
                    <a class="nav-link" href="/register">Register</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="confirmLogout()">Logout</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div id="map"></div>

</body>
</html>
